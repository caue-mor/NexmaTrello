generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Activity {
  id        String       @id @default(cuid())
  boardId   String
  cardId    String?
  userId    String
  clientId  String?
  type      ActivityType
  metadata  Json?
  createdAt DateTime     @default(now())
  board     Board        @relation("ActivityToBoard", fields: [boardId], references: [id], onDelete: Cascade)
  card      Card?        @relation("ActivityToCard", fields: [cardId], references: [id], onDelete: Cascade)
  client    Client?      @relation("ActivityToClient", fields: [clientId], references: [id], onDelete: Cascade)
  user      User         @relation("ActivityToUser", fields: [userId], references: [id], onDelete: Cascade)

  @@index([boardId])
  @@index([cardId])
  @@index([clientId])
  @@index([createdAt])
  @@index([userId])
}

model Attachment {
  id        String   @id
  cardId    String
  userId    String
  fileName  String
  fileUrl   String
  fileSize  Int
  mimeType  String
  createdAt DateTime @default(now())
  card      Card     @relation("AttachmentToCard", fields: [cardId], references: [id], onDelete: Cascade)
  user      User     @relation("AttachmentToUser", fields: [userId], references: [id], onDelete: Cascade)

  @@index([cardId])
  @@index([userId])
}

model Board {
  id                String              @id
  title             String
  isOrgWide         Boolean             @default(false)
  ownerId           String
  createdAt         DateTime            @default(now())
  updatedAt         DateTime
  activities        Activity[]          @relation("ActivityToBoard")
  owner             User                @relation("UserOwnedBoards", fields: [ownerId], references: [id])
  members           BoardMember[]       @relation("BoardToMember")
  cards             Card[]              @relation("BoardToCard")
  columns           Column[]            @relation("BoardToColumn")
  checklistTemplates ChecklistTemplate[] @relation("ChecklistTemplateToBoard")
  invites           Invite[]            @relation("InviteToBoard")
  labels            Label[]             @relation("LabelToBoard")
  notes             Note[]              @relation("NoteToBoard")
  tickets           Ticket[]            @relation("TicketToBoard")
  automations       Automation[]
}

model BoardMember {
  id       String   @id
  boardId  String
  userId   String
  role     Role     @default(MEMBER)
  joinedAt DateTime @default(now())
  board    Board    @relation("BoardToMember", fields: [boardId], references: [id], onDelete: Cascade)
  user     User     @relation("UserBoardMemberships", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([boardId, userId])
  @@index([boardId])
  @@index([userId])
}

model Card {
  id           String         @id
  boardId      String
  columnId     String
  title        String
  description  String?
  urgency      Urgency        @default(MEDIUM)
  order        Int            @default(0)
  createdById  String
  clientId     String?
  dueAt        DateTime?
  completedAt  DateTime?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime
  activities   Activity[]     @relation("ActivityToCard")
  attachments  Attachment[]   @relation("AttachmentToCard")
  board        Board          @relation("BoardToCard", fields: [boardId], references: [id], onDelete: Cascade)
  client       Client?        @relation("ClientToCard", fields: [clientId], references: [id])
  column       Column         @relation("ColumnToCard", fields: [columnId], references: [id], onDelete: Cascade)
  createdBy    User           @relation("CardCreator", fields: [createdById], references: [id])
  assignees    CardAssignee[] @relation("CardToAssignee")
  labels       CardLabel[]    @relation("CardToLabel")
  checklists   Checklist[]    @relation("CardToChecklist")
  comments          Comment[]          @relation("CardToComment")
  notes             Note[]             @relation("NoteToCard")
  notifications     Notification[]     @relation("NotificationToCard")
  taskContributions TaskContribution[] @relation("TaskContributionToCard")
  tickets           Ticket[]           @relation("TicketToCard")

  @@index([boardId])
  @@index([clientId])
  @@index([columnId, order])
  @@index([completedAt])
  @@index([createdById])
  @@index([dueAt])
  @@index([urgency])
}

model CardAssignee {
  cardId     String
  userId     String
  assignedAt DateTime @default(now())
  card       Card     @relation("CardToAssignee", fields: [cardId], references: [id], onDelete: Cascade)
  user       User     @relation("UserCardAssignments", fields: [userId], references: [id], onDelete: Cascade)

  @@id([cardId, userId])
  @@index([cardId])
  @@index([userId])
}

model CardLabel {
  cardId  String
  labelId String
  card    Card   @relation("CardToLabel", fields: [cardId], references: [id], onDelete: Cascade)
  label   Label  @relation("CardToLabel", fields: [labelId], references: [id], onDelete: Cascade)

  @@id([cardId, labelId])
  @@index([cardId])
  @@index([labelId])
}

model Checklist {
  id            String          @id
  cardId        String
  title         String
  card          Card            @relation("CardToChecklist", fields: [cardId], references: [id], onDelete: Cascade)
  items         ChecklistItem[] @relation("ChecklistToItem")

  @@index([cardId])
}

model ChecklistItem {
  id          String    @id
  checklistId String
  content     String
  done        Boolean   @default(false)
  doneAt      DateTime?
  doneBy      String?
  checklist   Checklist @relation("ChecklistToItem", fields: [checklistId], references: [id], onDelete: Cascade)
  user        User?     @relation("ChecklistItemDoneBy", fields: [doneBy], references: [id], onDelete: SetNull)

  @@index([checklistId])
  @@index([doneAt])
  @@index([done])
  @@index([doneBy])
}

model TaskContribution {
  id                  String   @id @default(cuid())
  cardId              String
  userId              String
  tasksMarked         Int      @default(0)
  totalTasks          Int
  contributionPercent Float    @default(0)
  xpEarned            Int      @default(0)
  coinsEarned         Int      @default(0)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  card                Card     @relation("TaskContributionToCard", fields: [cardId], references: [id], onDelete: Cascade)
  user                User     @relation("TaskContributionToUser", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([cardId, userId])
  @@index([userId])
  @@index([cardId])
}

model ChecklistTemplate {
  id          String   @id
  boardId     String
  name        String
  description String?
  items       Json
  createdAt   DateTime @default(now())
  updatedAt   DateTime
  board       Board    @relation("ChecklistTemplateToBoard", fields: [boardId], references: [id], onDelete: Cascade)

  @@index([boardId])
}

model Client {
  id            String        @id
  name          String
  status        ClientStatus  @default(NORMAL)
  onboardStatus OnboardStatus @default(ONBOARD)
  lead          Int           @default(0)
  phone         String?
  email         String?
  document      String?
  sector        String?
  region        String?
  notes         String?
  firstContact  DateTime?     @default(now())
  lastContact   DateTime
  createdAt     DateTime      @default(now())
  updatedAt     DateTime
  activities    Activity[]    @relation("ActivityToClient")
  cards         Card[]        @relation("ClientToCard")

  @@index([createdAt])
  @@index([email])
  @@index([onboardStatus])
  @@index([status])
}

model Column {
  id      String  @id
  boardId String
  title   String
  order   Int
  isFixed Boolean @default(false)
  cards   Card[]  @relation("ColumnToCard")
  board   Board   @relation("BoardToColumn", fields: [boardId], references: [id], onDelete: Cascade)

  @@index([boardId])
}

model Comment {
  id        String   @id
  cardId    String
  userId    String
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime
  card      Card     @relation("CardToComment", fields: [cardId], references: [id], onDelete: Cascade)
  user      User     @relation("UserComments", fields: [userId], references: [id], onDelete: Cascade)

  @@index([cardId])
  @@index([userId])
}

model Invite {
  id           String       @id
  boardId      String
  email        String
  token        String       @unique
  status       InviteStatus @default(PENDING)
  role         Role         @default(MEMBER)
  invitedById  String
  expiresAt    DateTime
  createdAt    DateTime     @default(now())
  acceptedById String?
  acceptedBy   User?        @relation("Invite_acceptedByIdToUser", fields: [acceptedById], references: [id])
  board        Board        @relation("InviteToBoard", fields: [boardId], references: [id], onDelete: Cascade)
  invitedBy    User         @relation("Invite_invitedByIdToUser", fields: [invitedById], references: [id])

  @@index([boardId])
  @@index([email])
  @@index([token])
}

model Label {
  id        String      @id
  boardId   String
  name      String
  color     String
  cardLabels CardLabel[] @relation("CardToLabel")
  board     Board       @relation("LabelToBoard", fields: [boardId], references: [id], onDelete: Cascade)

  @@index([boardId])
}

model Note {
  id        String    @id
  title     String
  content   String
  scope     NoteScope
  userId    String
  boardId   String?
  cardId    String?
  isPinned  Boolean   @default(false)
  tags      String[]
  color     String?
  createdAt DateTime  @default(now())
  updatedAt DateTime
  board     Board?    @relation("NoteToBoard", fields: [boardId], references: [id], onDelete: Cascade)
  card      Card?     @relation("NoteToCard", fields: [cardId], references: [id], onDelete: Cascade)
  user      User      @relation("NoteToUser", fields: [userId], references: [id], onDelete: Cascade)

  @@index([boardId])
  @@index([cardId])
  @@index([createdAt])
  @@index([isPinned])
  @@index([scope])
  @@index([userId])
}

model Notification {
  id             String           @id
  userId         String
  type           NotificationType
  title          String
  message        String
  readAt         DateTime?
  createdAt      DateTime         @default(now())
  relatedCardId  String?
  relatedBoardId String?
  card           Card?            @relation("NotificationToCard", fields: [relatedCardId], references: [id], onDelete: Cascade)
  user           User             @relation("NotificationToUser", fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([relatedCardId])
  @@index([userId])
  @@index([userId, readAt])
}

model Session {
  id        String   @id
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model User {
  id                               String            @id
  email                            String            @unique
  name                             String?
  passwordHash                     String
  isActive                         Boolean           @default(true)
  createdAt                        DateTime          @default(now())
  updatedAt                        DateTime
  activities                       Activity[]        @relation("ActivityToUser")
  attachments                      Attachment[]      @relation("AttachmentToUser")
  ownedBoards                      Board[]           @relation("UserOwnedBoards")
  boardMemberships                 BoardMember[]     @relation("UserBoardMemberships")
  createdCards                     Card[]            @relation("CardCreator")
  cardAssignments                  CardAssignee[]    @relation("UserCardAssignments")
  comments                         Comment[]         @relation("UserComments")
  Invite_Invite_acceptedByIdToUser Invite[]          @relation("Invite_acceptedByIdToUser")
  Invite_Invite_invitedByIdToUser  Invite[]          @relation("Invite_invitedByIdToUser")
  notes                            Note[]            @relation("NoteToUser")
  notifications                    Notification[]      @relation("NotificationToUser")
  Session                          Session[]
  achievements                     UserAchievement[]   @relation("AchievementToUser")
  stats                            UserStats?          @relation("StatsToUser")
  notificationPreferences          NotificationPreferences?

  // Google Calendar Integration
  googleToken                      GoogleToken?

  taskContributions                TaskContribution[]  @relation("TaskContributionToUser")
  checklistItemsMarked             ChecklistItem[]     @relation("ChecklistItemDoneBy")
  
  // Ticket relations
  requestedTickets                 Ticket[]            @relation("TicketRequester")
  assignedTickets                  Ticket[]            @relation("TicketAssignee")
  ticketHistory                    TicketHistory[]     @relation("TicketHistoryToUser")
  timeEntries                      TimeEntry[]         @relation("TimeEntryToUser")
  ticketComments                   TicketComment[]     @relation("TicketCommentToUser")
  ticketAttachments                TicketAttachment[]  @relation("TicketAttachmentToUser")
}

model UserAchievement {
  id             String    @id @default(cuid())
  userId         String
  achievementKey String
  unlockedAt     DateTime  @default(now())
  claimedAt      DateTime?
  user           User      @relation("AchievementToUser", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, achievementKey])
  @@index([achievementKey])
  @@index([userId])
}

model UserStats {
  id                     String    @id @default(cuid())
  userId                 String    @unique
  level                  Int       @default(1)
  xp                     Int       @default(0)
  coins                  Int       @default(0)
  currentStreak          Int       @default(0)
  longestStreak          Int       @default(0)
  lastActiveDate         DateTime?
  tasksCompleted         Int       @default(0)
  tasksCompletedOnTime   Int       @default(0)
  cardsCompleted         Int       @default(0)
  cardsCompletedOnTime   Int       @default(0)
  criticalCardsCompleted Int       @default(0)
  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @default(now())
  user                   User      @relation("StatsToUser", fields: [userId], references: [id], onDelete: Cascade)

  @@index([level])
  @@index([userId])
  @@index([xp])
}

model Ticket {
  id              String            @id @default(cuid())
  ticketNumber    Int               @unique
  title           String
  description     String?
  type            TicketType        @default(TASK)
  priority        TicketPriority    @default(MEDIUM)
  status          TicketStatus      @default(OPEN)
  
  // Rastreamento de pessoas
  requesterId     String
  assignedToId    String?
  
  // Rastreamento de tempo
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  startedAt       DateTime?
  resolvedAt      DateTime?
  closedAt        DateTime?
  dueDate         DateTime?
  
  // SLA (Service Level Agreement)
  slaDeadline     DateTime?
  slaViolated     Boolean           @default(false)
  
  // Tempo gasto
  estimatedHours  Float?
  actualHours     Float?
  
  // Relacionamentos
  boardId         String
  cardId          String?           // Opcional: vincular a um card existente
  googleEventId   String?           // ID do evento no Google Calendar
  
  board           Board             @relation("TicketToBoard", fields: [boardId], references: [id], onDelete: Cascade)
  card            Card?             @relation("TicketToCard", fields: [cardId], references: [id], onDelete: SetNull)
  requester       User              @relation("TicketRequester", fields: [requesterId], references: [id], onDelete: Cascade)
  assignedTo      User?             @relation("TicketAssignee", fields: [assignedToId], references: [id], onDelete: SetNull)
  
  // Hist√≥rico e anexos
  comments        TicketComment[]
  attachments     TicketAttachment[]
  history         TicketHistory[]
  timeEntries     TimeEntry[]
  
  @@index([ticketNumber])
  @@index([requesterId])
  @@index([assignedToId])
  @@index([status])
  @@index([priority])
  @@index([createdAt])
  @@index([boardId])
  @@index([cardId])
}

model TicketHistory {
  id          String   @id @default(cuid())
  ticketId    String
  userId      String
  action      String
  field       String?
  oldValue    String?
  newValue    String?
  createdAt   DateTime @default(now())
  
  ticket      Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  user        User     @relation("TicketHistoryToUser", fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([ticketId])
  @@index([userId])
  @@index([createdAt])
}

model TimeEntry {
  id          String   @id @default(cuid())
  ticketId    String
  userId      String
  description String?
  hours       Float
  date        DateTime @default(now())
  createdAt   DateTime @default(now())
  
  ticket      Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  user        User     @relation("TimeEntryToUser", fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([ticketId])
  @@index([userId])
  @@index([date])
}

model TicketComment {
  id          String   @id @default(cuid())
  ticketId    String
  userId      String
  content     String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  ticket      Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  user        User     @relation("TicketCommentToUser", fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([ticketId])
  @@index([userId])
  @@index([createdAt])
}

model TicketAttachment {
  id          String   @id @default(cuid())
  ticketId    String
  userId      String
  fileName    String
  fileUrl     String
  fileSize    Int
  mimeType    String
  createdAt   DateTime @default(now())
  
  ticket      Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  user        User     @relation("TicketAttachmentToUser", fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([ticketId])
  @@index([userId])
}

enum TicketType {
  BUG
  FEATURE
  TASK
  SUPPORT
  URGENT
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
  CRITICAL
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  WAITING
  RESOLVED
  CLOSED
  CANCELLED
}

model Automation {
  id            String   @id @default(cuid())
  boardId       String
  name          String
  triggerType   String
  triggerConfig Json
  actionType    String
  actionConfig  Json
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  board         Board    @relation(fields: [boardId], references: [id], onDelete: Cascade)

  @@index([boardId])
}

enum ActivityType {
  BOARD_CREATED
  BOARD_UPDATE
  CARD_CREATED
  CARD_UPDATED
  CARD_MOVED
  CARD_DELETED
  CARD_ASSIGNED
  CARD_UNASSIGNED
  CHECKLIST_CREATED
  CHECKLIST_ITEM_COMPLETED
  CHECKLIST_ITEM_UNCOMPLETED
  COMMENT_ADDED
  ATTACHMENT_ADDED
  ATTACHMENT_DELETED
  LABEL_ADDED
  LABEL_REMOVED
  CLIENT_STATUS_CHANGED
  DUE_DATE_CHANGED
}

enum ClientStatus {
  NORMAL
  NEUTRO
  URGENTE
  EMERGENCIA
}

enum InviteStatus {
  PENDING
  ACCEPTED
  DECLINED
  EXPIRED
}

enum NoteScope {
  PERSONAL
  BOARD
  CARD
}

enum NotificationType {
  INVITE
  ALERT
  MENTION
  ASSIGNMENT
  COMMENT
  DUE_DATE
  BOARD_UPDATE
}

model NotificationPreferences {
  id                String   @id @default(cuid())
  userId            String   @unique
  
  // Channels
  emailEnabled      Boolean  @default(true)
  pushEnabled       Boolean  @default(true)
  soundEnabled      Boolean  @default(true)
  
  // Types
  mentions          Boolean  @default(true)
  assignments       Boolean  @default(true)
  comments          Boolean  @default(true)
  deadlines         Boolean  @default(true)
  boardUpdates      Boolean  @default(false)
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
}

enum OnboardStatus {
  ONBOARD
  ATIVO
  INATIVO
}

enum Role {
  OWNER
  ADMIN
  MEMBER
}

enum Urgency {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

model GoogleToken {
  id           String   @id @default(cuid())
  userId       String   @unique
  accessToken  String
  refreshToken String?
  expiryDate   BigInt?
  
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model BoardTemplate {
  id          String   @id @default(cuid())
  title       String
  description String?
  category    String   @default("Geral")
  columns     Json     // Array of column titles
  cards       Json?    // Optional default cards structure
  isPublic    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([category])
}
